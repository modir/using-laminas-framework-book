# Приложение Г. Введение в Doctrine {#doctrine-intro}

В этом приложении мы сделаем обзор библиотеки Doctrine, в частности ее архитектуры и
компонентов. Так как в нашей книге мы, в основном, сосредотачиваемся на таком компоненте Doctrine,
как объектно-реляционный проектор (Object Relational Mapper или ORM), это приложение даст вам
более широкую картину других возможностей библиотеки.

## Doctrine и системы управления базами данных

На рынке существует много систем управления базами данных (СУБД). Эти системы можно разделить на две
группы: традиционные *реляционные базы данных*, использующие язык SQL для обработки запросов и управления данными,
и *NoSQL базы данных* ("not only SQL" - не только SQL), использующие ряд других подходов.
В каждом отдельном проекте можно выбрать оптимальную для него СУБД вследствие ее возможностей и конкурентных преимуществ.

### Реляционные базы данных

*Реляционная база данных* (от англ. relation - «отношение», «зависимость», «связь») содержит набор таблиц (отношений),
состоящих из строк. Строка в свою очередь может иметь один или несколько столбцов. Строка (или строки) может быть связана
со строкой (или строками) другой таблицы, тем самым формируя взаимосвязь между данными.

Например, предположим, что у вас есть сайт в виде блога, и его БД содержит две таблицы: таблицу `post` и
таблицу `comment`. У таблицы `post` будут столбцы с именами `id`, `title`, `content`, `author`, `date_created`;
у таблицы `comment` - `id`, `post_id`, `author`, `content` и `date_created`. Эти таблицы связаны по типу
"один-ко-многим", так как один пост может иметь ноль или больше (гораздо больше) комментариев, в то время как комментарии
могут принадлежать лишь одному посту.

Эти таблицы, а также их столбцы и взаимосвязь показаны ниже на рисунке Г.1.

![Рисунок Г.1. Таблицы и взаимосвязь между ними. Один пост имеет много комментариев](../en/images/doctrine_intro/post_comment_relationship.png)

На рынке реляционных баз данных довольно большое количество крупных представителей. Среди них: [SQLite](http://www.sqlite.org),
[MySQL](http://www.mysql.com/), [PostgreSQL](http://www.postgresql.org/), [Oracle](https://www.oracle.com/index.html),
[Microsoft SQL Server](https://www.microsoft.com/en-us/cloud-platform/sql-server) и т.д.

У каждой из них есть свои собственные функции, которых нет у других СУБД. Так, например:

  * SQLite разработана как встроенное расширение PHP-движка и не требует установки, однако хорошо
    работает только с простыми сайтами.

  * MySQL - бесплатная система, очень проста в установке и администрировании. Подходит для использования
    в системах малого и среднего размера;

  * Коммерческая СУБД Oracle направлена, в основном, на крупномасштабные системы и имеет сложные
    инструменты администрирования;

  * PostgreSQL поддерживает БД любого размера и может считаться open source-аналогом Oracle.

Библиотека Doctrine предназначена для работы со всеми крупными базами данных с помощью унифицированного интерфейса программирования.
Этот интерфейс программирования реализован на двух уровнях.

  1. На нижнем уровне Doctrine предоставляет единый механизм для построения SQL-запросов к любой
	 поддерживаемой реляционной БД и управления схемой БД. Этот механизм реализован в компоненте
	  *Database Abstraction Layer* (DBAL, абстрактный уровень базы данных).

  2. На высшем уровне компонент ORM (объектно-реляционный проектор) обеспечивает возможность
     запрашивать и управлять данными БД объектно-ориентированным способом, устанавливая соответствие между
	 таблицами и PHP-классами. Этот компонент также предоставляет свой собственный язык запросов, DQL,
	 позволяющий строить запросы в объектно-ориентированном стиле.

Как правило, используется API, предоставляемый компонентом ORM. В то же время вы вполне можете работать
с компонентом нижнего уровня DBAL, если находите его более подходящим для ваших проектов.

I> Doctrine не зависит от конкретной базы данных. Теоретически, при использовании Doctrine вы абстрагируетесь от
I> типов БД и переключаетесь между базами гораздо проще, чем при использовании зависимых от БД решений.

#### SQL против DQL

При использовании реляционной базы данных, как правило, используют язык SQL, как стандартный способ доступа
к данным БД и управления ее схемой. Однако, каждая СУБД обычно имеет свои собственные расширения языка SQL-запросов
(диалекты).

I> Библиотека Doctrine предназначена для работы со всеми крупными реляционными системами баз данных, использующими язык SQL,
I> но, очевидно, она поддерживает только некоторое подмножество их функциональности и возможностей языка SQL.

Doctrine построена на основе PDO [^pdo], расширения PHP (и других расширений для работы с БД, таких как `sqlite`, `mysqli`,
`oci8`, и др.). Эти расширения предоставляют драйвера для всех крупных систем реляционных БД. Вы указываете, какой драйвер
использовать, при настройке подключения к базе данных.

T> Если вы еще не знакомы с SQL, хороший способ изучения его синтаксиса это
T> [руководства W3Schools](http://www.w3schools.com/sql/default.asp).

[^pdo]: PDO (PHP Data Objects - объекты данных PHP) - это расширение, определяющее простой и согласованный интерфейс
для доступа к базам данных в PHP. Чтобы не зависеть от конкретной БД, PDO использует концепцию драйверов баз данных.
Каждый драйвер, реализующий интерфейс PDO, позволяет использовать особенности БД как обычные функции расширения.

Так как компонент ORM предназначен для работы с объектами, а не таблицами, он предоставляет свой собственный "объектно-ориентированный"
язык запросов, который называется *DQL* [^dql]. Он схож с SQL в том, что позволяет писать и выполнять запросы к БД, но результатом запроса
в нем является не не массив табличных строк, а массив объектов.

[^dql]: DQL расшифровывается как Doctrine Query Language (язык запросов Doctrine).

### NoSQL БД

В отличие от реляционных систем БД, NoSQL (not only SQL) системы - как следует из их названия - используют
другие методы доступа к данным. Это значит, что каждая NoSQL система может иметь свои собственные методы
и API для доступа к данным и управления ими. Формально NoSQL базы данных можно разделить на следующие группы:

  * **Документные хранилища**. Документо-ориентированная база данных использует понятие *документов и их полей*. Это полезно,
     например, если у вас есть иерархическое дерево документа в системе управления содержимым. Документы обращаются
	 к базе через ключ, уникальный для каждого документа. Одна из других определяющих характеристик документо-ориентированных
	 БД возможность - помимо простого поиска пар документ-ключ для извлечения документа - использовать API или язык
	 запросов для извлечения документов, основываясь на их содержимом.

  * **Колоночные хранилища**. Часто используются в веб-индексировании. Колоночные (или столбцовые) СУБД -
     это системы управления базами данных, которые хранят данные по колонкам (столбцам), а не по строкам, как это делают
	 большинство реляционных СУБД. Колоночные СУБД имеют преимущества для хранилищ данных, систем управления взаимоотношениями
     с клиентами (customer relationship management systems или CRM systems), библиотечных каталогов и других
	 подобных справочных систем, где агрегаты вычисляются из большого количества похожих элементов данных.

  * **Хранилища типа «ключ-значение»**. Эти хранилища самые простые. Они используют уникальные ключи для доступа
      к определенным данным. Такие системы БД предоставляют простой механизм поиска пар ключ-значение.

  * и другие.

I> Doctrine обеспечивает поддержку только подмножества документных хранилищ систем БД NoSQL. Системы колоночных хранилищ и
хранилищ типа «ключ-значение», как правило, используют специфические приложения и не охватываются Doctrine.

#### Документо-ориентированные базы данных

Doctrine поддерживает большое количество документных хранилищ: [MongoDB](https://www.mongodb.org/),
[CouchDB](http://couchdb.apache.org/), [OrientDB](http://www.orientechnologies.com/orientdb/) и
[PHPCR](http://phpcr.github.io/).

Например, на сайте, где вы ведете блог, у вас будут документы с именами `post` и `comment`.
У документа `post` будут поля `id`, `title`, `content`, `author`, `date_created`; у документа
`comment` - `id`, `author`, `content` and `date_created`. Это очень похоже на те таблицы, которые
мы рассматривали ранее в реляционной базе данных.

I> В этой книге мы не будем обращаться к API, предоставляемому Doctrine для документо-ориентированных NoSQL-баз.
Если вы хотите узнать об этих возможностях, обратитесь к соответствующим разделам документации проекта
Doctrine.

## Архитектура Doctrine

[Проект Doctrine](http://www.doctrine-project.org/) состоит из нескольких библиотек (компонентов).
Каждый компонент Doctrine распространяется как пакет для установки Composer'ом и зарегистрирован в
каталоге [Packagist.org](https://packagist.org/). Похожий метод использует Laminas Framework
для установки своих компонентов.

Ниже мы предоставим краткое описание архитектуры библиотеки Doctrine, чтобы дать вам
общее представление о ее возможностях.

### Компоненты, поддерживающие реляционные базы данных

Основные компоненты Doctrine предназначены для работы с реляционными БД и показаны на рисунке Г.2 (помечены зеленым).
Голубые блоки обозначают PHP-движок и расширения PHP, на основе которых построена Doctrine.

![Рисунок Г.2. Компоненты Doctrine, предназначенные для работы с реляционными БД](../en/images/doctrine_intro/doctrine_orm_architecture.png)

Как видно из рисунка, Doctrine основана на свойствах PHP-движка и расширениях PHP, которых обычно
используются как драйвера к определенным системам управления БД. Над этим базовым уровнем находятся
ключевые компоненты Doctrine (такие как  `Annotations`, `Common` и т.д), обеспечивающие необходимую
функциональность для других компонентов верхнего уровня. Компонент DBAL предоставляет абстрактный уровень
типа БД. На самом верхнем уровне находится компонент `ORM`, предоставляющий API для работы с данными
объектно-ориентированным методом. Компоненты DoctrineModule` and `DoctrineORMModule` предназначены для
интеграции с Laminas Framework.

I> Компонент ORM использует паттерн [Data Mapper (преобразователь данных)](http://en.wikipedia.org/wiki/Data_mapper_pattern).
   Этот паттерн указывает на то, что таблица базы данных может быть представлена как PHP-класс сущности.
   База данных в этом паттерне считается чем-то вроде репозитория (хранилищем сущностей). Когда вы извлекаете
   сущность из репозитория, выполняется внутренний SQL-запрос и создается класс сущности, чьи свойства заполняются
   данными.

По аналогии с компонентами Laminas, имена компонентов Doctrine состоят из двух частей: имени поставщика ("Doctrine")
и имени компонента (например, "Common"). Ниже представлен список компонентов Doctrine вместе с именами их пакетов,
устанавливаемыми Composer'ом, и краткими описаниями:


  * `Doctrine\Common`. Общая библиотека для проектов Doctrine. Этот компонент предоставляет
     широко используемый набор функций. Имя пакета, устанавливаемого Composer'ом - `doctrine/common`.

  * `Doctrine\Annotations`. Парсер многострочных комментариев. Имя пакета, устанавливаемого Composer'ом -
    `doctrine/annotations`.

  * `Doctrine\Inflector`. Манипуляции со строками, касающиеся изменения регистра и единственного/множественного числа.
     Имя пакета, устанавливаемого Composer'ом - `doctrine/inflector`.

  * `Doctrine\Lexer`. Базовая библиотека для лексического анализатора, который может использоваться в нисходящем синтаксическом анализе и методе рекурсивного спуска.
     Имя пакета, устанавливаемого Composer'ом - `doctrine/lexer`.

  * `Doctrine\Cache`. Библиотека для кэширования, предлагающая объектно-ориентированный API для многих бэкендов кеша.
     Имя пакета, устанавливаемого Composer'ом - `doctrine/cache`.

  * `Doctrine\DBAL`. Абстрактный уровень БД. This is a lightweight and thin runtime layer around
     a PDO-like API and a lot of additional, horizontal features like database schema introspection and
	 manipulation through an object oriented API. Имя пакета, устанавливаемого Composer'ом - `doctrine/dbal`.

  * `Doctrine\Collections`. Библиотека для абстракции коллекций. Имя пакета, устанавливаемого Composer'ом -
    `doctrine/collections`.

  * `Doctrine\ORM`. Компонент для объектно-реляционного отображения. Позволяет работать с моделями сущностей
     объектно-ориентированным методом вместо запросов на чистом SQL. Имя пакета, устанавливаемого Composer'ом - `doctrine/orm`.

  * `Doctrine\Migrations`. Миграции схем БД с использованием Doctrine DBAL. Предоставляет последовательный
    способ управления схемой БД и ее обновления. Имя пакета, устанавливаемого Composer'ом - `doctrine/migrations`.

  * `Doctrine\DataFixtures`. Данные предварительной настройки для всех менеджеров объектов Doctrine.
    Предоставляет фреймворк для создания данных предварительной настройки. Имя пакета, устанавливаемого Composer'ом -
	`doctrine/data-fixtures`.

Так как Doctrine использует автозагрузку PHP, а также стандарт PSR-4, классы, принадлежащие определенному компоненту,
"живут" в пространстве имен этого компонента. Например, класс `EntityManager`, принадлежащий компоненту `Doctrine\ORM`,
живет в пространстве имен `Doctrine\ORM`.

### Компоненты, поддерживающие документоориентированные NoSQL-БД

Компоненты Doctrine, предназначенные для работы с NoSQL-базами (MongoDB, CouchDB и т.д.) показаны
на рисунке Г.3 и отмечены зеленым. Голубые блоки обозначают PHP-движок и расширения PHP, на основе
которых построена Doctrine.

![Рисунок Г.3. Компоненты Doctrine, предназначенные для работы с документо-ориентированными БД](../en/images/doctrine_intro/doctrine_odm_architecture.png)

Как видно из рисунка Г.3, компоненты Doctrine для NoSQL-БД основаны на свойствах PHP-движка и расширениях PHP, которые
можно считать "драйверами" для определенных систем управления базами данных. Выше находятся компоненты среднего уровня.
Компонент `Common` - тот же самый, что был показан на рисунке Г.2; он представляет широко используемый набор функций.
Компоненты `Mongodb` и `CouchDB` предоставляют низкоуровневые API соответствующим базам данных. Компоненты
`MongodbODM`, `CouchdbODBM`, `OrientdbODM` и `PhpcrODM` предоставляют ODM (Object Document Mappers) для соответствующих БД.
Концепция ODM очень похожа на ORM тем, что тоже предоставляет возможность работать с NoSQL-БД объектно-ориентированным методом,
устанавливая соответствие между документами и моделями сущностей PHP. Компонент `DoctrineMongoODMModule` предназначен для
интеграции с Laminas.


Ниже представлен список компонентов вместе с именами их пакетов,
устанавливаемыми Composer'ом, и краткими описаниями:

  * `Doctrine\MongoDB` - уровень абстракции Dotrine MongoDB. Имя пакета, устанавливаемого Composer'ом -
   `doctrine/mongodb`.

  * `Doctrine\MongodbODM` (Object Document Mapper) предоставляет возможность устанавливать соответствие между документами NoSQL и
    моделями сущностей PHP. Имя пакета, устанавливаемого Composer'ом - `doctrine/mongodb-odm`.

  * `Doctrine\MongoODMModule` - модуль Laminas Framework, обеспечивающий функциональность Doctrine MongoDB ODM.
     Он служит для простой интеграции с Laminas. Имя пакета, устанавливаемого Composer'ом -
	`doctrine/doctrine-mongo-odm-module`.

  * `Doctrine\CouchDB` - компонент, предоставляющий API, который является оберткой для API CouchDB для доступа по HTTP.
     Имя пакета, устанавливаемого Composer'ом -`doctrine/couchdb`.

  * `Doctrine\CouchDB` - компонент CouchDB Document Object Mapper. Аналогично Doctrine ORM он
    предоставляет возможность доступа к БД объектно-ориентированным методом. Имя пакета, устанавливаемого
	Composer'ом -`doctrine/couchdb`.

  * `Doctrine\OrientdbODM` - набор библиотек PHP для использования OrientDB. Имя пакета, устанавливаемого
	Composer'ом -`doctrine/couchdb`.

  * `Doctrine\PhpcrODM` - это Object Document Mapper для PHPCR. Имя пакета, устанавливаемого
	Composer'ом -`doctrine/couchdb`.

## Выводы

В этом приложении мы сделали обзор архитектуры библиотеки Doctrine и ее компонентов. Doctrine - большой проект,
состоящий из множественных компонентов, в основном, направленных на сохранение данных.

В данный момент на рынке БД существуют две большие группы систем управления базами данных: традиционные реляционные
базы данных и так называемые NoSQL-базы. Хотя большинство реляционных БД используют язык SQL для запросов и управления данными,
каждая система имеет свои особенности. То же самое можно сказать и про NoSQL-базы, где каждая система предоставляет свой
собственный метод доступа к данным. Doctrine предназначена для работы с данными независимо от конкретной БД с помощью
сложных уровней абстракции.

Наиболее полезный компонент Doctrine, Object Relational Mapper (объектно-реляционный проектор) разработан для того, чтобы
дать разработчику возможность работать с данными объектно-ориентированным методом. Это когда вместо написания SQL-запроса
вы загружаете объект сущности (или массив объектов сущностей) из репозитория. В этом случае таблице БД ставится в соответствие
PHP-класс (также называемый сущностью), а строке из этой таблицы - экземпляр класса данной сущности.
